---

# This play book is intend for one pass execution

- name: do host preparation
  hosts: aws
  tasks:
    - name: change apt mirror.list
      copy: src={{ resources_dir }}/aws/sources.list dest=/etc/apt/sources.list mode=0644
      become: true

    - name: install apt-metalink
      copy: src={{ resources_dir }}/aws/apt-metalink dest=/usr/bin/apt-metalink mode=0755
      become: true

    - name: add apt-fast repository
      shell: >-
        sudo add-apt-repository ppa:saiarcot895/myppa

    - name: install dependencies
      apt: name={{ item }} update_cache=yes cache_valid_time=3600
      become: true
      with_items:
        - apt-fast

    - name: prepare install docker, add key
      shell: >-
        apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
      become: true

    - name: add docker to apt sources.list.d
      shell: >-
        echo "deb https://mirrors.tuna.tsinghua.edu.cn/docker/apt/repo ubuntu-trusty main" | tee /etc/apt/sources.list.d/docker.list
      become: true


    - name: install packages
      shell: >-
        apt-fast update
        apt-fast -y install docker-engine
      become: true
      with_items:
        - docker-engine

    - name: add user to docker group
      user: name=ubuntu groupds=docker append=yes
      become: true
